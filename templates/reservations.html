{% extends "base.html" %}

{% block content %}
<!-- FullCalendar CSS -->
<link href='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.10/index.global.min.css' rel='stylesheet' />
<style>
    /* Custom Scrollbar for modern look */
    ::-webkit-scrollbar {
        width: 8px;
        height: 8px;
    }

    ::-webkit-scrollbar-track {
        background: transparent;
    }

    ::-webkit-scrollbar-thumb {
        background: #cbd5e1;
        border-radius: 4px;
    }

    ::-webkit-scrollbar-thumb:hover {
        background: #94a3b8;
    }

    /* FullCalendar Customization */
    .fc {
        font-family: 'Noto Sans KR', sans-serif;
        --fc-border-color: rgba(226, 232, 240, 0.6);
        --fc-page-bg-color: transparent;
    }

    .fc-theme-standard td,
    .fc-theme-standard th {
        border-color: var(--fc-border-color);
    }

    .fc-col-header-cell {
        background-color: rgba(248, 250, 252, 0.5);
        padding: 12px 0;
        font-weight: 600;
        color: #475569;
    }

    .fc-daygrid-day-number {
        color: #64748b;
        font-weight: 500;
        padding: 8px;
    }

    .fc-event {
        border: none !important;
        border-radius: 6px;
        padding: 2px 4px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
        font-size: 0.85rem;
        font-weight: 500;
        cursor: pointer;
        transition: transform 0.1s;
    }

    .fc-event:hover {
        transform: scale(1.02);
    }

    .fc-toolbar-title {
        font-size: 1.5rem !important;
        font-weight: 700;
        color: #1e293b;
    }

    .fc-button {
        background-color: white !important;
        border: 1px solid #e2e8f0 !important;
        color: #475569 !important;
        font-weight: 500 !important;
        box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05) !important;
        text-transform: capitalize;
        border-radius: 0.5rem !important;
    }

    .fc-button:hover {
        background-color: #f8fafc !important;
        color: #1e293b !important;
    }

    .fc-button-active {
        background-color: #eff6ff !important;
        color: #3b82f6 !important;
        border-color: #3b82f6 !important;
    }

    /* Weekend Styling */
    .fc-day-sun {
        background-color: #fef2f2 !important;
    }

    .fc-day-sat {
        background-color: #eff6ff !important;
    }

    .fc-day-sun .fc-daygrid-day-number,
    .fc-col-header-cell.fc-day-sun .fc-col-header-cell-cushion {
        color: #ef4444 !important;
    }

    .fc-day-sat .fc-daygrid-day-number,
    .fc-col-header-cell.fc-day-sat .fc-col-header-cell-cushion {
        color: #3b82f6 !important;
    }
</style>

<div class="space-y-8">
    <!-- 1. Header Section -->
    <div class="flex flex-col md:flex-row md:items-center md:justify-between">
        <div>
            <h1 class="text-3xl font-bold text-gray-900 tracking-tight">ì˜ˆì•½ í˜„í™©</h1>
            <p class="mt-2 text-gray-500">
                ì˜¤ëŠ˜ì˜ ì…ì‹¤ ê³ ê°ê³¼ ì „ì²´ ìŠ¤ì¼€ì¤„ì„ í•œëˆˆì— í™•ì¸í•˜ì„¸ìš”.
            </p>
        </div>
        <div class="mt-4 md:mt-0">
            <!-- Status Cards or Summary could go here -->
        </div>
    </div>

    <!-- 2. ì˜ˆì•½ ë“±ë¡ í¼ -->
    <div
        class="relative overflow-hidden rounded-2xl bg-white/70 backdrop-blur-xl shadow-[0_8px_30px_rgb(0,0,0,0.04)] border border-white/50">
        <div class="px-6 py-6 sm:p-8">
            <h3 class="text-xl font-bold text-gray-900 mb-6 flex items-center">
                <span class="bg-indigo-100 text-indigo-600 rounded-lg p-2 mr-3">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
                    </svg>
                </span>
                ìƒˆ ì˜ˆì•½ ë“±ë¡
            </h3>

            <form id="reservationForm">
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                    <!-- Name -->
                    <div class="col-span-1">
                        <label for="guest_name" class="block text-sm font-semibold text-gray-700 mb-2">ì˜ˆì•½ì ì„±í•¨</label>
                        <input type="text" name="guest_name" id="guest_name" required
                            class="w-full px-4 py-3 rounded-xl bg-gray-50/50 border-transparent focus:border-indigo-500 focus:bg-white focus:ring-0 text-sm shadow-sm transition-all duration-200 placeholder-gray-400"
                            placeholder="í™ê¸¸ë™">
                    </div>

                    <!-- Phone -->
                    <div class="col-span-1">
                        <label for="phone_number" class="block text-sm font-semibold text-gray-700 mb-2">ì „í™”ë²ˆí˜¸</label>
                        <input type="text" name="phone_number" id="phone_number" placeholder="01012345678" required
                            class="w-full px-4 py-3 rounded-xl bg-gray-50/50 border-transparent focus:border-indigo-500 focus:bg-white focus:ring-0 text-sm shadow-sm transition-all duration-200 placeholder-gray-400">
                    </div>

                    <!-- Accommodation -->
                    <div class="col-span-1">
                        <label for="accommodation_name" class="block text-sm font-semibold text-gray-700 mb-2">ìˆ™ì†Œ
                            ì„ íƒ</label>
                        <div class="relative">
                            <select id="accommodation_name" name="accommodation_name"
                                class="w-full px-4 py-3 rounded-xl bg-gray-50/50 border-transparent focus:border-indigo-500 focus:bg-white focus:ring-0 text-sm shadow-sm transition-all duration-200 appearance-none cursor-pointer">
                                <option>ì´ˆì›ê³ íƒ1</option>
                                <option>ì´ˆì›ê³ íƒ2</option>
                                <option>ì´ˆì›ê³ íƒ3</option>
                                <option>ì´ˆì›ë³„ì¥(ì •ê¸€)</option>
                                <option>ì´ˆì›ë³„ì¥(ì‹œë„¤)</option>
                                <option>ì´ˆì›ë¸Œë¦¿ì§€</option>
                            </select>
                            <div
                                class="pointer-events-none absolute inset-y-0 right-0 flex items-center px-4 text-gray-500">
                                <svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M19 9l-7 7-7-7"></path>
                                </svg>
                            </div>
                        </div>
                    </div>

                    <!-- Memo (Hidden in simple view, or merged) -->
                    <!-- We'll keep layout clean, move dates next -->
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mt-6">
                    <!-- Checkin -->
                    <div class="col-span-1">
                        <label for="checkin_date" class="block text-sm font-semibold text-gray-700 mb-2">ì…ì‹¤ì¼</label>
                        <input type="date" name="checkin_date" id="checkin_date" required
                            class="w-full px-4 py-3 rounded-xl bg-gray-50/50 border-transparent focus:border-indigo-500 focus:bg-white focus:ring-0 text-sm shadow-sm transition-all duration-200 text-gray-600">
                    </div>

                    <!-- Checkout -->
                    <div class="col-span-1">
                        <label for="checkout_date" class="block text-sm font-semibold text-gray-700 mb-2">í‡´ì‹¤ì¼</label>
                        <input type="date" name="checkout_date" id="checkout_date" required
                            class="w-full px-4 py-3 rounded-xl bg-gray-50/50 border-transparent focus:border-indigo-500 focus:bg-white focus:ring-0 text-sm shadow-sm transition-all duration-200 text-gray-600">
                    </div>

                    <!-- Memo -->
                    <div class="col-span-1 md:col-span-2">
                        <label for="memo" class="block text-sm font-semibold text-gray-700 mb-2">ë©”ëª¨ (ì„ íƒ)</label>
                        <input type="text" id="memo" name="memo" placeholder="íŠ¹ì´ì‚¬í•­ ì…ë ¥"
                            class="w-full px-4 py-3 rounded-xl bg-gray-50/50 border-transparent focus:border-indigo-500 focus:bg-white focus:ring-0 text-sm shadow-sm transition-all duration-200 placeholder-gray-400">
                    </div>
                </div>

                <div class="mt-8 flex justify-end">
                    <button type="submit"
                        class="inline-flex items-center justify-center px-8 py-3 border border-transparent text-sm font-medium rounded-xl text-white bg-gradient-to-r from-indigo-600 to-purple-600 hover:from-indigo-700 hover:to-purple-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 shadow-lg transform transition hover:-translate-y-0.5">
                        ì˜ˆì•½ ë“±ë¡í•˜ê¸°
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- 2.5 Filter Section -->
    <div
        class="relative overflow-hidden rounded-2xl bg-white/70 backdrop-blur-xl shadow-[0_8px_30px_rgb(0,0,0,0.04)] border border-white/50 p-6 mb-8">
        <h3 class="text-lg font-bold text-gray-900 mb-4 flex items-center gap-2">
            <svg class="w-5 h-5 text-indigo-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                    d="M3 4a1 1 0 011-1h16a1 1 0 011 1v2.586a1 1 0 01-.293.707l-6.414 6.414a1 1 0 00-.293.707V17l-4 4v-6.586a1 1 0 00-.293-.707L3.293 7.293A1 1 0 013 6.586V4z" />
            </svg>
            ìˆ™ì†Œ í•„í„°
        </h3>
        <div class="flex flex-wrap items-center gap-4">
            <!-- Select All -->
            <label class="inline-flex items-center cursor-pointer">
                <input type="checkbox" id="filter-all" checked
                    class="form-checkbox h-5 w-5 text-indigo-600 rounded border-gray-300 focus:ring-indigo-500 transition duration-150 ease-in-out">
                <span class="ml-2 text-gray-700 font-medium">ì „ì²´ ì„ íƒ</span>
            </label>
            <div class="h-6 w-px bg-gray-300 mx-2"></div>
            <!-- Individual Filters -->
            <label class="inline-flex items-center cursor-pointer">
                <input type="checkbox" name="accommodation-filter" value="ì´ˆì›ê³ íƒ1" checked
                    class="form-checkbox h-5 w-5 text-emerald-500 rounded border-gray-300 focus:ring-emerald-400 transition duration-150 ease-in-out">
                <span class="ml-2 text-gray-700">ì´ˆì›ê³ íƒ1</span>
            </label>
            <label class="inline-flex items-center cursor-pointer">
                <input type="checkbox" name="accommodation-filter" value="ì´ˆì›ê³ íƒ2" checked
                    class="form-checkbox h-5 w-5 text-emerald-500 rounded border-gray-300 focus:ring-emerald-400 transition duration-150 ease-in-out">
                <span class="ml-2 text-gray-700">ì´ˆì›ê³ íƒ2</span>
            </label>
            <label class="inline-flex items-center cursor-pointer">
                <input type="checkbox" name="accommodation-filter" value="ì´ˆì›ê³ íƒ3" checked
                    class="form-checkbox h-5 w-5 text-emerald-500 rounded border-gray-300 focus:ring-emerald-400 transition duration-150 ease-in-out">
                <span class="ml-2 text-gray-700">ì´ˆì›ê³ íƒ3</span>
            </label>
            <label class="inline-flex items-center cursor-pointer">
                <input type="checkbox" name="accommodation-filter" value="ì´ˆì›ë³„ì¥(ì‹œë„¤)" checked
                    class="form-checkbox h-5 w-5 text-amber-500 rounded border-gray-300 focus:ring-amber-400 transition duration-150 ease-in-out">
                <span class="ml-2 text-gray-700">ì´ˆì›ë³„ì¥(ì‹œë„¤)</span>
            </label>
            <label class="inline-flex items-center cursor-pointer">
                <input type="checkbox" name="accommodation-filter" value="ì´ˆì›ë³„ì¥(ì •ê¸€)" checked
                    class="form-checkbox h-5 w-5 text-amber-500 rounded border-gray-300 focus:ring-amber-400 transition duration-150 ease-in-out">
                <span class="ml-2 text-gray-700">ì´ˆì›ë³„ì¥(ì •ê¸€)</span>
            </label>
            <label class="inline-flex items-center cursor-pointer">
                <input type="checkbox" name="accommodation-filter" value="ì´ˆì›ë¸Œë¦¿ì§€" checked
                    class="form-checkbox h-5 w-5 text-violet-500 rounded border-gray-300 focus:ring-violet-400 transition duration-150 ease-in-out">
                <span class="ml-2 text-gray-700">ì´ˆì›ë¸Œë¦¿ì§€</span>
            </label>
        </div>
    </div>

    <!-- 3. ì˜ˆì•½ ë‹¬ë ¥ (FullCalendar) -->
    <div
        class="relative overflow-hidden rounded-2xl bg-white/70 backdrop-blur-xl shadow-[0_8px_30px_rgb(0,0,0,0.04)] border border-white/50 p-6 sm:p-8">
        <div id='calendar' class="h-[700px]"></div>
    </div>
</div>

<!-- Edit Modal (Glassmorphism) -->
<div id="editModal" class="relative z-50 hidden" aria-labelledby="modal-title" role="dialog" aria-modal="true">
    <div class="fixed inset-0 bg-gray-900/30 backdrop-blur-sm transition-opacity"></div>
    <div class="fixed inset-0 z-10 overflow-y-auto">
        <div class="flex min-h-full items-center justify-center p-4 text-center sm:p-0">
            <div
                class="relative transform overflow-hidden rounded-2xl bg-white text-left shadow-2xl transition-all sm:my-8 sm:w-full sm:max-w-lg border border-gray-100">
                <div class="p-8 sm:p-10">
                    <h3 class="text-xl font-bold text-gray-900 mb-6" id="modal-title">ì˜ˆì•½ ìƒì„¸ ì •ë³´</h3>
                    <form id="editForm" class="space-y-5">
                        <input type="hidden" id="edit_id" name="id">

                        <div>
                            <label
                                class="block text-xs font-bold text-gray-500 uppercase tracking-wider mb-1">ìˆ™ì†Œ</label>
                            <select id="edit_accommodation_name" name="accommodation_name"
                                class="w-full px-3 py-2 rounded-lg bg-gray-50 text-gray-900 focus:ring-2 focus:ring-indigo-500 focus:outline-none border-none">
                                <option>ì´ˆì›ê³ íƒ1</option>
                                <option>ì´ˆì›ê³ íƒ2</option>
                                <option>ì´ˆì›ê³ íƒ3</option>
                                <option>ì´ˆì›ë³„ì¥(ì •ê¸€)</option>
                                <option>ì´ˆì›ë³„ì¥(ì‹œë„¤)</option>
                                <option>ì´ˆì›ë¸Œë¦¿ì§€</option>
                            </select>
                        </div>

                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label
                                    class="block text-xs font-bold text-gray-500 uppercase tracking-wider mb-1">ì˜ˆì•½ì</label>
                                <input type="text" id="edit_guest_name" name="guest_name"
                                    class="w-full px-3 py-2 rounded-lg bg-gray-50 text-gray-900 focus:ring-2 focus:ring-indigo-500 focus:outline-none border-none">
                            </div>
                            <div>
                                <label
                                    class="block text-xs font-bold text-gray-500 uppercase tracking-wider mb-1">ì „í™”ë²ˆí˜¸</label>
                                <input type="text" id="edit_phone_number" name="phone_number"
                                    class="w-full px-3 py-2 rounded-lg bg-gray-50 text-gray-900 focus:ring-2 focus:ring-indigo-500 focus:outline-none border-none">
                            </div>
                        </div>

                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label
                                    class="block text-xs font-bold text-gray-500 uppercase tracking-wider mb-1">ì…ì‹¤ì¼</label>
                                <input type="date" id="edit_checkin_date" name="checkin_date"
                                    class="w-full px-3 py-2 rounded-lg bg-gray-50 text-gray-900 focus:ring-2 focus:ring-indigo-500 focus:outline-none border-none">
                            </div>
                            <div>
                                <label
                                    class="block text-xs font-bold text-gray-500 uppercase tracking-wider mb-1">í‡´ì‹¤ì¼</label>
                                <input type="date" id="edit_checkout_date" name="checkout_date"
                                    class="w-full px-3 py-2 rounded-lg bg-gray-50 text-gray-900 focus:ring-2 focus:ring-indigo-500 focus:outline-none border-none">
                            </div>
                        </div>

                        <div>
                            <label
                                class="block text-xs font-bold text-gray-500 uppercase tracking-wider mb-1">ë©”ëª¨</label>
                            <textarea id="edit_memo" name="memo" rows="3"
                                class="w-full px-3 py-2 rounded-lg bg-gray-50 text-gray-900 focus:ring-2 focus:ring-indigo-500 focus:outline-none border-none"></textarea>
                        </div>
                    </form>
                </div>
                <div class="mt-8 pt-6 border-t border-gray-100">
                    <h4 class="text-sm font-bold text-gray-900 mb-3 flex items-center gap-2">
                        <svg class="w-4 h-4 text-indigo-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z" />
                        </svg>
                        ë¬¸ì ì¦‰ì‹œë°œì†¡
                    </h4>
                    <div class="flex gap-2">
                        <select id="sms_template"
                            class="flex-1 px-3 py-2 rounded-lg bg-gray-50 text-gray-900 text-sm focus:ring-2 focus:ring-indigo-500 border-none">
                            <option value="">í…œí”Œë¦¿ ì„ íƒ...</option>
                            <option value="checkin_guide_0900">ì²´í¬ì¸ì•ˆë‚´ (ì…ì‹¤ì¼ 09:00)</option>
                            <option value="checkin_1450">ì…ì‹¤ì•ˆë‚´ (ì…ì‹¤ì¼ 14:50)</option>
                            <option value="checkin_food_0900">ë§›ì§‘ì•ˆë‚´ (ì…ì‹¤ì¼ 09:00)</option>
                            <option value="checkin_1900">ì „ì²´ê³µí†µ ì €ë…ì•ˆë‚´ (ì…ì‹¤ì¼ 19:00)</option>
                            <option value="checkout_0900">ì „ì²´ê³µí†µ í‡´ì‹¤ì•ˆë‚´ (í‡´ì‹¤ì¼ 09:00)</option>
                            <option value="checkout_1700">ì „ì²´ê³µí†µ ë¦¬ë·°ìš”ì²­ (í‡´ì‹¤ì¼ 17:00)</option>
                            <option value="checkout_1900">í›„ê¸°ì‘ì„±ì•ˆë‚´ (í˜ì´ë°±, í‡´ì‹¤ì¼ 19:00)</option>
                            <option value="multinight_0900">ì—°ë°•ì•ˆë‚´ (ì—°ë°•ì¼ 09:00)</option>
                        </select>
                        <button type="button" onclick="sendManualSMS()"
                            class="px-4 py-2 bg-indigo-600 text-white text-sm font-semibold rounded-lg hover:bg-indigo-700 shadow-sm transition-colors whitespace-nowrap">
                            ì „ì†¡
                        </button>
                    </div>
                </div>

                <div class="mt-8 flex justify-end gap-3">
                    <button type="button" id="deleteBtn" onclick="deleteCurrentReservation()"
                        class="inline-flex w-full justify-center rounded-xl bg-red-50 px-4 py-2.5 text-sm font-semibold text-red-600 hover:bg-red-100 sm:w-auto">
                        ì‚­ì œ
                    </button>
                    <button type="button" onclick="updateReservation()"
                        class="inline-flex w-full justify-center rounded-xl bg-indigo-600 px-4 py-2.5 text-sm font-semibold text-white shadow-sm hover:bg-indigo-500 sm:w-auto">
                        ìˆ˜ì • ì €ì¥
                    </button>
                    <button type="button" onclick="closeEditModal()"
                        class="inline-flex w-full justify-center rounded-xl bg-white px-4 py-2.5 text-sm font-semibold text-gray-900 shadow-sm ring-1 ring-inset ring-gray-200 hover:bg-gray-50 sm:w-auto">
                        ì·¨ì†Œ
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- FullCalendar JS -->
<script src='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.10/index.global.min.js'></script>
<script>
    let calendar;

    document.addEventListener('DOMContentLoaded', function () {
        const calendarEl = document.getElementById('calendar');
        calendar = new FullCalendar.Calendar(calendarEl, {
            initialView: 'dayGridMonth',
            locale: 'ko',
            headerToolbar: {
                left: 'prev,next today',
                center: 'title',
                right: 'dayGridMonth,listWeek'
            },
            eventDisplay: 'block', // Force block display for events
            eventOrder: 'sortIdx', // [NEW] Sort events by custom property
            events: async function (info, successCallback, failureCallback) {
                try {
                    // 1. Fetch Reservations
                    const res = await fetch('/reservations/');
                    const data = await res.json();

                    // Filter Logic
                    const checkboxes = document.querySelectorAll('input[name="accommodation-filter"]');
                    const selectedAccommodations = Array.from(checkboxes)
                        .filter(cb => cb.checked)
                        .map(cb => cb.value);

                    const filteredData = data.filter(r => selectedAccommodations.includes(r.accommodation_name));

                    // Priority Map for Sorting
                    const sortPriority = {
                        'ì´ˆì›ê³ íƒ1': 1,
                        'ì´ˆì›ê³ íƒ2': 2,
                        'ì´ˆì›ê³ íƒ3': 3,
                        'ì´ˆì›ë³„ì¥(ì‹œë„¤)': 4,
                        'ì´ˆì›ë³„ì¥(ì •ê¸€)': 5,
                        'ì´ˆì›ë¸Œë¦¿ì§€': 6
                    };

                    const reservationEvents = filteredData.map(r => {
                        // ìˆ™ì†Œë³„ ìƒ‰ìƒ ì§€ì • (íŒŒìŠ¤í…” í†¤)
                        let color = '#3b82f6'; // blue
                        if (r.accommodation_name.includes('ê³ íƒ')) color = '#10b981'; // emerald
                        if (r.accommodation_name.includes('ë³„ì¥')) color = '#f59e0b'; // amber
                        if (r.accommodation_name.includes('ë¸Œë¦¿ì§€')) color = '#8b5cf6'; // violet

                        return {
                            id: r.id,
                            title: `${r.guest_name} (${r.accommodation_name})`,
                            start: r.checkin_date,
                            end: r.checkout_date,
                            allDay: true,
                            backgroundColor: color,
                            borderColor: color,
                            sortIdx: sortPriority[r.accommodation_name] || 99, // Sort key
                            extendedProps: { ...r }
                        };
                    });

                    // 2. Korean Holidays (2024-2025)
                    const holidays = [
                        // 2024
                        { title: 'ì‹ ì •', date: '2024-01-01' },
                        { title: 'ì„¤ë‚ ', date: '2024-02-09' },
                        { title: 'ì„¤ë‚ ', date: '2024-02-10' },
                        { title: 'ì„¤ë‚ ', date: '2024-02-11' },
                        { title: 'ëŒ€ì²´ê³µíœ´ì¼', date: '2024-02-12' },
                        { title: 'ì‚¼ì¼ì ˆ', date: '2024-03-01' },
                        { title: 'ì„ ê±°ì¼', date: '2024-04-10' },
                        { title: 'ì–´ë¦°ì´ë‚ ', date: '2024-05-05' },
                        { title: 'ëŒ€ì²´ê³µíœ´ì¼', date: '2024-05-06' },
                        { title: 'ë¶€ì²˜ë‹˜ì˜¤ì‹ ë‚ ', date: '2024-05-15' },
                        { title: 'í˜„ì¶©ì¼', date: '2024-06-06' },
                        { title: 'ê´‘ë³µì ˆ', date: '2024-08-15' },
                        { title: 'ì¶”ì„', date: '2024-09-16' },
                        { title: 'ì¶”ì„', date: '2024-09-17' },
                        { title: 'ì¶”ì„', date: '2024-09-18' },
                        { title: 'ê°œì²œì ˆ', date: '2024-10-03' },
                        { title: 'í•œê¸€ë‚ ', date: '2024-10-09' },
                        { title: 'í¬ë¦¬ìŠ¤ë§ˆìŠ¤', date: '2024-12-25' },

                        // 2025 (Estimates & Fixed)
                        { title: 'ì‹ ì •', date: '2025-01-01' },
                        { title: 'ì„¤ë‚ ', date: '2025-01-28' },
                        { title: 'ì„¤ë‚ ', date: '2025-01-29' },
                        { title: 'ì„¤ë‚ ', date: '2025-01-30' },
                        { title: 'ì‚¼ì¼ì ˆ', date: '2025-03-01' },
                        { title: 'ëŒ€ì²´ê³µíœ´ì¼', date: '2025-03-03' },
                        { title: 'ì–´ë¦°ì´ë‚ ', date: '2025-05-05' },
                        { title: 'ë¶€ì²˜ë‹˜ì˜¤ì‹ ë‚ ', date: '2025-05-05' }, // ê²¹ì¹¨
                        { title: 'ëŒ€ì²´ê³µíœ´ì¼', date: '2025-05-06' },
                        { title: 'í˜„ì¶©ì¼', date: '2025-06-06' },
                        { title: 'ê´‘ë³µì ˆ', date: '2025-08-15' },
                        { title: 'ì¶”ì„', date: '2025-10-05' },
                        { title: 'ì¶”ì„', date: '2025-10-06' },
                        { title: 'ì¶”ì„', date: '2025-10-07' },
                        { title: 'ê°œì²œì ˆ', date: '2025-10-03' },
                        { title: 'í•œê¸€ë‚ ', date: '2025-10-09' },
                        { title: 'í¬ë¦¬ìŠ¤ë§ˆìŠ¤', date: '2025-12-25' },

                        // 2026
                        { title: 'ì‹ ì •', date: '2026-01-01' },
                        { title: 'ì„¤ë‚ ', date: '2026-02-16' },
                        { title: 'ì„¤ë‚ ', date: '2026-02-17' },
                        { title: 'ì„¤ë‚ ', date: '2026-02-18' },
                        { title: 'ì‚¼ì¼ì ˆ', date: '2026-03-01' },
                        { title: 'ëŒ€ì²´ê³µíœ´ì¼', date: '2026-03-02' },
                        { title: 'ì–´ë¦°ì´ë‚ ', date: '2026-05-05' },
                        { title: 'ë¶€ì²˜ë‹˜ì˜¤ì‹ ë‚ ', date: '2026-05-24' },
                        { title: 'ëŒ€ì²´ê³µíœ´ì¼', date: '2026-05-25' },
                        { title: 'í˜„ì¶©ì¼', date: '2026-06-06' },
                        { title: 'ê´‘ë³µì ˆ', date: '2026-08-15' },
                        { title: 'ì¶”ì„', date: '2026-09-24' },
                        { title: 'ì¶”ì„', date: '2026-09-25' },
                        { title: 'ì¶”ì„', date: '2026-09-26' },
                        { title: 'ê°œì²œì ˆ', date: '2026-10-03' },
                        { title: 'í•œê¸€ë‚ ', date: '2026-10-09' },
                        { title: 'í¬ë¦¬ìŠ¤ë§ˆìŠ¤', date: '2026-12-25' }
                    ];

                    const holidayEvents = holidays.map(h => ({
                        title: h.title,
                        start: h.date,
                        allDay: true,
                        display: 'background', // ë°°ê²½ìƒ‰ìœ¼ë¡œ í‘œì‹œ
                        backgroundColor: '#fee2e2', // ë¶‰ì€ ë°°ê²½ (ì§„í•˜ê²Œ)
                        classNames: ['holiday-event'] // ì¶”ê°€ ìŠ¤íƒ€ì¼ë§ìš© í´ë˜ìŠ¤
                    }));

                    const holidayTextEvents = holidays.map(h => ({
                        title: `ğŸ‰ ${h.title}`,
                        start: h.date,
                        allDay: true,
                        backgroundColor: 'transparent',
                        borderColor: 'transparent',
                        textColor: '#ef4444',
                        classNames: ['font-bold']
                    }));

                    successCallback([...holidayEvents, ...holidayTextEvents, ...reservationEvents]);
                } catch (err) {
                    failureCallback(err);
                }
            },
            eventClick: function (info) {
                openEditModal(info.event);
            }
        });
        calendar.render();

        // 3. Filter Event Listeners
        const filterAll = document.getElementById('filter-all');
        const filterCheckboxes = document.querySelectorAll('input[name="accommodation-filter"]');

        // "Select All" click
        filterAll.addEventListener('change', (e) => {
            const isChecked = e.target.checked;
            filterCheckboxes.forEach(cb => {
                cb.checked = isChecked;
            });
            calendar.refetchEvents();
        });

        // Individual Checkbox click
        filterCheckboxes.forEach(cb => {
            cb.addEventListener('change', () => {
                // Determine if all are checked
                const allChecked = Array.from(filterCheckboxes).every(c => c.checked);
                filterAll.checked = allChecked;

                // If not all valid, maybe uncheck "All"? Yes.
                // But also if user manually checks them all one by one, "Select All" should become checked.

                calendar.refetchEvents();
            });
        });
    });

    // --- Create ---
    document.getElementById('reservationForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        const formData = new FormData(e.target);
        const data = Object.fromEntries(formData.entries());

        try {
            const res = await fetch('/reservations/', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            });
            if (res.ok) {
                alert('ì˜ˆì•½ì´ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤.');
                e.target.reset();
                calendar.refetchEvents(); // ë‹¬ë ¥ ìƒˆë¡œê³ ì¹¨
            } else {
                alert('ë“±ë¡ ì‹¤íŒ¨: ' + await res.text());
            }
        } catch (err) {
            alert('ì˜¤ë¥˜ ë°œìƒ: ' + err);
        }
    });

    // --- Modal Logic ---
    function openEditModal(event) {
        const props = event.extendedProps;
        document.getElementById('edit_id').value = event.id;
        document.getElementById('edit_guest_name').value = props.guest_name;
        document.getElementById('edit_phone_number').value = props.phone_number;
        document.getElementById('edit_accommodation_name').value = props.accommodation_name;
        document.getElementById('edit_checkin_date').value = props.checkin_date;
        document.getElementById('edit_checkout_date').value = props.checkout_date;
        document.getElementById('edit_memo').value = props.memo || '';

        document.getElementById('editModal').classList.remove('hidden');
    }

    function closeEditModal() {
        document.getElementById('editModal').classList.add('hidden');
    }

    // [NEW] í…œí”Œë¦¿ ì„ íƒ ì‹œ ì œëª©/ë‚´ìš© ë¶ˆëŸ¬ì˜¤ê¸° - Subject Input removed, logic not needed for UI.
    // Backend handles subject automatically if not provided.

    async function sendManualSMS() {
        const id = document.getElementById('edit_id').value;
        const templateType = document.getElementById('sms_template').value;
        // const subject = document.getElementById('sms_subject').value; // Removed

        if (!id) {
            showCustomAlert('ì˜ˆì•½ ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
            return;
        }
        if (!templateType) {
            showCustomAlert('ë°œì†¡í•  í…œí”Œë¦¿ì„ ì„ íƒí•´ì£¼ì„¸ìš”.');
            return;
        }

        if (!confirm('ì •ë§ë¡œ ë¬¸ìë¥¼ ë°œì†¡í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;

        try {
            const res = await fetch('/api/sms/send-manual', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    reservation_id: parseInt(id),
                    template_type: templateType,
                    // subject: subject // Let backend handle it
                })
            });
            if (res.ok) {
                showCustomAlert('ë¬¸ìê°€ ì„±ê³µì ìœ¼ë¡œ ë°œì†¡ë˜ì—ˆìŠµë‹ˆë‹¤.', 'ë°œì†¡ ì„±ê³µ');
            } else {
                const errorData = await res.json();
                showCustomAlert(errorData.detail || 'ë¬¸ì ë°œì†¡ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.', 'ë°œì†¡ ì‹¤íŒ¨');
            }
        } catch (err) {
            showCustomAlert('ì„œë²„ í†µì‹  ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'ì˜¤ë¥˜');
            console.error(err);
        }
    }

    // --- Update ---
    async function updateReservation() {
        const id = document.getElementById('edit_id').value;
        const form = document.getElementById('editForm');
        const formData = new FormData(form);
        const data = Object.fromEntries(formData.entries());

        try {
            const res = await fetch(`/reservations/${id}`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            });
            if (res.ok) {
                alert('ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤.');
                closeEditModal();
                calendar.refetchEvents();
            } else {
                alert('ìˆ˜ì • ì‹¤íŒ¨: ' + await res.text());
            }
        } catch (err) {
            alert('ì˜¤ë¥˜ ë°œìƒ: ' + err);
        }
    }

    // --- Delete ---
    async function deleteCurrentReservation() {
        if (!confirm('ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
        const id = document.getElementById('edit_id').value;
        try {
            const res = await fetch(`/reservations/${id}`, { method: 'DELETE' });
            if (res.ok) {
                alert('ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.');
                closeEditModal();
                calendar.refetchEvents();
            } else {
                alert('ì‚­ì œ ì‹¤íŒ¨');
            }
        } catch (err) {
            alert('ì˜¤ë¥˜ ë°œìƒ');
        }
    }
</script>
{% endblock %}